/* WebUploader 0.1.2 */
(function(i,e){var g={},b=function(m,l){var k,o,n;if(typeof m==="string"){return f(m)}else{k=[];for(o=m.length,n=0;n<o;n++){k.push(f(m[n]))}return l.apply(null,k)}},a=function(m,k,l){if(arguments.length===2){l=k;k=null}b(k||[],function(){j(m,l,arguments)})},j=function(m,l,k){var n={exports:l},o;if(typeof l==="function"){k.length||(k=[b,n.exports,n]);o=l.apply(null,k);o!==undefined&&(n.exports=o)}g[m]=n.exports},f=function(k){var l=g[k]||i[k];if(!l){throw new Error("`"+k+"` is undefined")}return l},d=function(n){var l,k,p,o,m,q;q=function(r){return r&&(r.charAt(0).toUpperCase()+r.substr(1))};for(l in g){k=n;if(!g.hasOwnProperty(l)){continue}p=l.split("/");m=q(p.pop());while((o=q(p.shift()))){k[o]=k[o]||{};k=k[o]}k[m]=g[l]}},c=e(i,a,b),h;d(c);if(typeof module==="object"&&typeof module.exports==="object"){module.exports=c}else{if(typeof define==="function"&&define.amd){define([],c)}else{h=i.WebUploader;i.WebUploader=c;i.WebUploader.noConflict=function(){i.WebUploader=h}}}})(this,function(c,a,b){a("dollar-third",[],function(){return c.jQuery||c.Zepto});a("dollar",["dollar-third"],function(d){return d});a("promise-third",["dollar"],function(d){return{Deferred:d.Deferred,when:d.when,isPromise:function(e){return e&&typeof e.then==="function"}}});a("promise",["promise-third"],function(d){return d});a("base",["dollar","promise"],function(d,i){var h=function(){},f=Function.call;function j(k){return function(){return f.apply(k,arguments)}}function e(l,k){return function(){return l.apply(k,arguments)}}function g(l){var k;if(Object.create){return Object.create(l)}else{k=function(){};k.prototype=l;return new k()}}return{version:"0.1.2",$:d,Deferred:i.Deferred,isPromise:i.isPromise,when:i.when,browser:(function(q){var o={},r=q.match(/WebKit\/([\d.]+)/),k=q.match(/Chrome\/([\d.]+)/)||q.match(/CriOS\/([\d.]+)/),m=q.match(/MSIE\s([\d\.]+)/)||q.match(/(?:trident)(?:.*rv:([\w.]+))?/i),l=q.match(/Firefox\/([\d.]+)/),p=q.match(/Safari\/([\d.]+)/),n=q.match(/OPR\/([\d.]+)/);r&&(o.webkit=parseFloat(r[1]));k&&(o.chrome=parseFloat(k[1]));m&&(o.ie=parseFloat(m[1]));l&&(o.firefox=parseFloat(l[1]));p&&(o.safari=parseFloat(p[1]));n&&(o.opera=parseFloat(n[1]));return o})(navigator.userAgent),os:(function(n){var m={},k=n.match(/(?:Android);?[\s\/]+([\d.]+)?/),l=n.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);k&&(m.android=parseFloat(k[1]));l&&(m.ios=parseFloat(l[1].replace(/_/g,".")));return m})(navigator.userAgent),inherits:function(n,l,m){var k;if(typeof l==="function"){k=l;l=null}else{if(l&&l.hasOwnProperty("constructor")){k=l.constructor}else{k=function(){return n.apply(this,arguments)}}}d.extend(true,k,n,m||{});k.__super__=n.prototype;k.prototype=g(n.prototype);l&&d.extend(true,k.prototype,l);return k},noop:h,bindFn:e,log:(function(){if(c.console){return e(console.log,console)}return h})(),nextTick:(function(){return function(k){setTimeout(k,1)}})(),slice:j([].slice),guid:(function(){var k=0;return function(n){var l=(+new Date()).toString(32),m=0;for(;m<5;m++){l+=Math.floor(Math.random()*65535).toString(32)}return(n||"wu_")+l+(k++).toString(32)}})(),formatSize:function(l,k,n){var m;n=n||["B","K","M","G","TB"];while((m=n.shift())&&l>1024){l=l/1024}return(m==="B"?l:l.toFixed(k||2))+m}}});a("mediator",["base"],function(e){var d=e.$,j=[].slice,i=/\s+/,h;function g(l,o,m,n){return d.grep(l,function(p){return p&&(!o||p.e===o)&&(!m||p.cb===m||p.cb._cb===m)&&(!n||p.ctx===n)})}function f(m,l,n){d.each((m||"").split(i),function(o,p){n(p,l)})}function k(m,l){var q=false,o=-1,p=m.length,n;while(++o<p){n=m[o];if(n.cb.apply(n.ctx2,l)===false){q=true;break}}return !q}h={on:function(o,l,m){var n=this,p;if(!l){return this}p=this._events||(this._events=[]);f(o,l,function(s,q){var r={e:s};r.cb=q;r.ctx=m;r.ctx2=m||n;r.id=p.length;p.push(r)});return this},once:function(o,l,m){var n=this;if(!l){return n}f(o,l,function(q,p){var r=function(){n.off(q,r);return p.apply(m||n,arguments)};r._cb=p;n.on(q,r,m)});return n},off:function(o,l,m){var n=this._events;if(!n){return this}if(!o&&!l&&!m){this._events=[];return this}f(o,l,function(q,p){d.each(g(n,q,p,m),function(){delete n[this.id]})});return this},trigger:function(o){var m,n,l;if(!this._events||!o){return this}m=j.call(arguments,1);n=g(this._events,o);l=g(this._events,"all");return k(n,m)&&k(l,arguments)}};return d.extend({installTo:function(l){return d.extend(l,h)}},h)});a("uploader",["base","mediator"],function(e,f){var d=e.$;function g(h){this.options=d.extend(true,{},g.options,h);this._init(this.options)}g.options={};f.installTo(g.prototype);d.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(i,h){g.prototype[i]=function(){return this.request(h,arguments)}});d.extend(g.prototype,{state:"pending",_init:function(i){var h=this;h.request("init",i,function(){h.state="ready";h.trigger("ready")})},option:function(h,j){var i=this.options;if(arguments.length>1){if(d.isPlainObject(j)&&d.isPlainObject(i[h])){d.extend(i[h],j)}else{i[h]=j}}else{return h?i[h]:i}},getStats:function(){var h=this.request("get-stats");return{successNum:h.numOfSuccess,cancelNum:h.numOfCancel,invalidNum:h.numOfInvalid,uploadFailNum:h.numOfUploadFailed,queueNum:h.numOfQueue}},trigger:function(k){var h=[].slice.call(arguments,1),j=this.options,i="on"+k.substring(0,1).toUpperCase()+k.substring(1);if(f.trigger.apply(this,arguments)===false||d.isFunction(j[i])&&j[i].apply(this,h)===false||d.isFunction(this[i])&&this[i].apply(this,h)===false||f.trigger.apply(f,[this,k].concat(h))===false){return false}return true},request:e.noop});e.create=g.create=function(h){return new g(h)};e.Uploader=g;return g});a("runtime/runtime",["base","mediator"],function(e,h){var d=e.$,f={},g=function(k){for(var j in k){if(k.hasOwnProperty(j)){return j}}return null};function i(j){this.options=d.extend({container:document.body},j);this.uid=e.guid("rt_")}d.extend(i.prototype,{getContainer:function(){var k=this.options,l,j;if(this._container){return this._container}l=d(k.container||document.body);j=d(document.createElement("div"));j.attr("id","rt_"+this.uid);j.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});l.append(j);l.addClass("webuploader-container");this._container=j;return j},init:e.noop,exec:e.noop,destroy:function(){if(this._container){this._container.parentNode.removeChild(this.__container)}this.off()}});i.orders="html5,flash";i.addRuntime=function(k,j){f[k]=j};i.hasRuntime=function(j){return !!(j?f[j]:g(f))};i.create=function(j,k){var m,l;k=k||i.orders;d.each(k.split(/\s*,\s*/g),function(){if(f[this]){m=this;return false}});m=m||g(f);if(!m){throw new Error("Runtime Error")}l=new f[m](j);return l};h.installTo(i.prototype);return i});a("runtime/client",["base","mediator","runtime/runtime"],function(d,f,g){var e;e=(function(){var i={};return{add:function(j){i[j.uid]=j},get:function(k,l){var j;if(k){return i[k]}for(j in i){if(l&&i[j].__standalone){continue}return i[j]}return null},remove:function(j){delete i[j.uid]}}})();function h(i,l){var j=d.Deferred(),k;this.uid=d.guid("client_");this.runtimeReady=function(m){return j.done(m)};this.connectRuntime=function(n,m){if(k){throw new Error("already connected!")}j.done(m);if(typeof n==="string"&&e.get(n)){k=e.get(n)}k=k||e.get(null,l);if(!k){k=g.create(n,n.runtimeOrder);k.__promise=j.promise();k.once("ready",j.resolve);k.init();e.add(k);k.__client=1}else{d.$.extend(k.options,n);k.__promise.then(j.resolve);k.__client++}l&&(k.__standalone=l);return k};this.getRuntime=function(){return k};this.disconnectRuntime=function(){if(!k){return}k.__client--;if(k.__client<=0){e.remove(k);delete k.__promise;k.destroy()}k=null};this.exec=function(){if(!k){return}var m=d.slice(arguments);i&&m.unshift(i);return k.exec.apply(this,m)};this.getRuid=function(){return k&&k.uid};this.destroy=(function(m){return function(){m&&m.apply(this,arguments);this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()}})(this.destroy)}f.installTo(h.prototype);return h});a("lib/blob",["base","runtime/client"],function(d,f){function e(h,i){var g=this;g.source=i;g.ruid=h;f.call(g,"Blob");this.uid=i.uid||this.uid;this.type=i.type||"";this.size=i.size||0;if(h){g.connectRuntime(h)}}d.inherits(f,{constructor:e,slice:function(h,g){return this.exec("slice",h,g)},getSource:function(){return this.source}});return e});a("lib/file",["base","lib/blob"],function(d,e){var h=1,g=/\.([^.]+)$/;function f(k,j){var i;e.apply(this,arguments);this.name=j.name||("untitled"+h++);i=g.exec(j.name)?RegExp.$1.toLowerCase():"";if(!i&&this.type){i=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(this.type)?RegExp.$1.toLowerCase():"";this.name+="."+i}if(!this.type&&~"jpg,jpeg,png,gif,bmp".indexOf(i)){this.type="image/"+(i==="jpg"?"jpeg":i)}this.ext=i;this.lastModifiedDate=j.lastModifiedDate||(new Date()).toLocaleString()}return d.inherits(e,f)});a("lib/filepicker",["base","runtime/client","lib/file"],function(e,h,f){var d=e.$;function g(i){i=this.options=d.extend({},g.options,i);i.container=d(i.id);if(!i.container.length){throw new Error("按钮指定错误")}i.innerHTML=i.innerHTML||i.label||i.container.html()||"";i.button=d(i.button||document.createElement("div"));i.button.html(i.innerHTML);i.container.html(i.button);h.call(this,"FilePicker",true)}g.options={button:null,container:null,label:null,innerHTML:null,multiple:true,accept:null,name:"file"};e.inherits(h,{constructor:g,init:function(){var j=this,k=j.options,i=k.button;i.addClass("webuploader-pick");j.on("all",function(m){var l;switch(m){case"mouseenter":i.addClass("webuploader-pick-hover");break;case"mouseleave":i.removeClass("webuploader-pick-hover");break;case"change":l=j.exec("getFiles");j.trigger("select",d.map(l,function(n){n=new f(j.getRuid(),n);n._refer=k.container;return n}),k.container);break}});j.connectRuntime(k,function(){j.refresh();j.exec("init",k);j.trigger("ready")});d(c).on("resize",function(){j.refresh()})},refresh:function(){var l=this.getRuntime().getContainer(),i=this.options.button,m=i.outerWidth?i.outerWidth():i.width(),j=i.outerHeight?i.outerHeight():i.height(),k=i.offset();m&&j&&l.css({bottom:"auto",right:"auto",width:m+"px",height:j+"px"}).offset(k)},enable:function(){var i=this.options.button;i.removeClass("webuploader-pick-disable");this.refresh()},disable:function(){var i=this.options.button;this.getRuntime().getContainer().css({top:"-99999px"});i.addClass("webuploader-pick-disable")},destroy:function(){if(this.runtime){this.exec("destroy");this.disconnectRuntime()}}});return g});a("widgets/widget",["base","uploader"],function(f,i){var d=f.$,e=i.prototype._init,g={},k=[];function h(m){if(!m){return false}var l=m.length,n=d.type(m);if(m.nodeType===1&&l){return true}return n==="array"||n!=="function"&&n!=="string"&&(l===0||typeof l==="number"&&l>0&&(l-1) in m)}function j(l){this.owner=l;this.options=l.options}d.extend(j.prototype,{init:f.noop,invoke:function(l,m){var n=this.responseMap;if(!n||!(l in n)||!(n[l] in this)||!d.isFunction(this[n[l]])){return g}return this[n[l]].apply(this,m)},request:function(){return this.owner.request.apply(this.owner,arguments)}});d.extend(i.prototype,{_init:function(){var l=this,m=l._widgets=[];d.each(k,function(n,o){m.push(new o(l))});return e.apply(l,arguments)},request:function(l,m,n){var p=0,w=this._widgets,r=w.length,u=[],o=[],v,t,s,q;m=h(m)?m:[m];for(;p<r;p++){v=w[p];t=v.invoke(l,m);if(t!==g){if(f.isPromise(t)){o.push(t)}else{u.push(t)}}}if(n||o.length){s=f.when.apply(f,o);q=s.pipe?"pipe":"then";return s[q](function(){var y=f.Deferred(),x=arguments;setTimeout(function(){y.resolve.apply(y,x)},1);return y.promise()})[q](n||f.noop)}else{return u[0]}}});i.register=j.register=function(n,o){var m={init:"init"},l;if(arguments.length===1){o=n;o.responseMap=m}else{o.responseMap=d.extend(m,n)}l=f.inherits(j,o);k.push(l);return l};return j});a("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(e,g,f){var d=e.$;d.extend(g.options,{pick:null,accept:null});return g.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(h){this.pickers=[];return h.pick&&this.addButton(h.pick)},refresh:function(){d.each(this.pickers,function(){this.refresh()})},addButton:function(m){var j=this,l=j.options,h=l.accept,k,n,i;if(!m){return}i=e.Deferred();d.isPlainObject(m)||(m={id:m});k=d.extend({},m,{accept:d.isPlainObject(h)?[h]:h,swf:l.swf,runtimeOrder:l.runtimeOrder});n=new f(k);n.once("ready",i.resolve);n.on("select",function(o){j.owner.request("add-file",[o])});n.init();this.pickers.push(n);return i.promise()},disable:function(){d.each(this.pickers,function(){this.disable()})},enable:function(){d.each(this.pickers,function(){this.enable()})}})});a("lib/image",["base","runtime/client","lib/blob"],function(e,h,f){var d=e.$;function g(i){this.options=d.extend({},g.options,i);h.call(this,"Image");this.on("load",function(){this._info=this.exec("info");this._meta=this.exec("meta")})}g.options={quality:90,crop:false,preserveHeaders:true,allowMagnify:true};e.inherits(h,{constructor:g,info:function(i){if(i){this._info=i;return this}return this._info},meta:function(i){if(i){this._meta=i;return this}return this._meta},loadFromBlob:function(i){var j=this,k=i.getRuid();this.connectRuntime(k,function(){j.exec("init",j.options);j.exec("loadFromBlob",i)})},resize:function(){var i=e.slice(arguments);return this.exec.apply(this,["resize"].concat(i))},getAsDataUrl:function(i){return this.exec("getAsDataUrl",i)},getAsBlob:function(j){var i=this.exec("getAsBlob",j);return new f(this.getRuid(),i)}});return g});a("widgets/image",["base","uploader","lib/image","widgets/widget"],function(e,h,f){var d=e.$,g;g=(function(i){var j=0,l=[],k=function(){var m;while(l.length&&j<i){m=l.shift();j+=m[0];m[1]()}};return function(n,o,m){l.push([o,m]);n.once("destroy",function(){j-=o;setTimeout(k,1)});setTimeout(k,1)}})(5*1024*1024);d.extend(h.options,{thumb:{width:110,height:110,quality:70,allowMagnify:true,crop:true,preserveHeaders:false,type:"image/jpeg"},compress:{width:1600,height:1600,quality:90,allowMagnify:false,crop:false,preserveHeaders:true}});return h.register({"make-thumb":"makeThumb","before-send-file":"compressImage"},{makeThumb:function(j,i,n,k){var m,l;j=this.request("get-file",j);if(!j.type.match(/^image/)){i(true);return}m=d.extend({},this.options.thumb);if(d.isPlainObject(n)){m=d.extend(m,n);n=null}n=n||m.width;k=k||m.height;l=new f(m);l.once("load",function(){j._info=j._info||l.info();j._meta=j._meta||l.meta();l.resize(n,k)});l.once("complete",function(){i(false,l.getAsDataUrl(m.type));l.destroy()});l.once("error",function(){i(true);l.destroy()});g(l,j.source.size,function(){j._info&&l.info(j._info);j._meta&&l.meta(j._meta);l.loadFromBlob(j.source)})},compressImage:function(k){var m=this.options.compress||this.options.resize,i=m&&m.compressSize||300*1024,l,j;k=this.request("get-file",k);if(!m||!~"image/jpeg,image/jpg".indexOf(k.type)||k.size<i||k._compressed){return}m=d.extend({},m);j=e.Deferred();l=new f(m);j.always(function(){l.destroy();l=null});l.once("error",j.reject);l.once("load",function(){k._info=k._info||l.info();k._meta=k._meta||l.meta();l.resize(m.width,m.height)});l.once("complete",function(){var n,p;try{n=l.getAsBlob(m.type);p=k.size;if(n.size<p){k.source=n;k.size=n.size;k.trigger("resize",n.size,p)}k._compressed=true;j.resolve()}catch(o){j.resolve()}});k._info&&l.info(k._info);k._meta&&l.meta(k._meta);l.loadFromBlob(k.source);return j.promise()}})});a("file",["base","mediator"],function(e,i){var d=e.$,g="WU_FILE_",h=0,j=/\.([^.]+)$/,k={};function f(){return g+h++}function l(m){this.name=m.name||"Untitled";this.size=m.size||0;this.type=m.type||"application";this.lastModifiedDate=m.lastModifiedDate||(new Date()*1);this.id=f();this.ext=j.exec(this.name)?RegExp.$1:"";this.statusText="";k[this.id]=l.Status.INITED;this.source=m;this.loaded=0;this.on("error",function(n){this.setStatus(l.Status.ERROR,n)})}d.extend(l.prototype,{setStatus:function(n,o){var m=k[this.id];typeof o!=="undefined"&&(this.statusText=o);if(n!==m){k[this.id]=n;this.trigger("statuschange",n,m)}},getStatus:function(){return k[this.id]},getSource:function(){return this.source},destory:function(){delete k[this.id]}});i.installTo(l.prototype);l.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"};return l});a("queue",["base","mediator","file"],function(e,f,i){var d=e.$,h=i.Status;function g(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0};this._queue=[];this._map={}}d.extend(g.prototype,{append:function(j){this._queue.push(j);this._fileAdded(j);return this},prepend:function(j){this._queue.unshift(j);this._fileAdded(j);return this},getFile:function(j){if(typeof j!=="string"){return j}return this._map[j]},fetch:function(m){var l=this._queue.length,k,j;m=m||h.QUEUED;for(k=0;k<l;k++){j=this._queue[k];if(m===j.getStatus()){return j}}return null},sort:function(j){if(typeof j==="function"){this._queue.sort(j)}},getFiles:function(){var n=[].slice.call(arguments,0),m=[],k=0,l=this._queue.length,j;for(;k<l;k++){j=this._queue[k];if(n.length&&!~d.inArray(j.getStatus(),n)){continue}m.push(j)}return m},_fileAdded:function(k){var l=this,j=this._map[k.id];if(!j){this._map[k.id]=k;k.on("statuschange",function(m,n){l._onFileStatusChange(m,n)})}k.setStatus(h.QUEUED)},_onFileStatusChange:function(j,k){var l=this.stats;switch(k){case h.PROGRESS:l.numOfProgress--;break;case h.QUEUED:l.numOfQueue--;break;case h.ERROR:l.numOfUploadFailed--;break;case h.INVALID:l.numOfInvalid--;break}switch(j){case h.QUEUED:l.numOfQueue++;break;case h.PROGRESS:l.numOfProgress++;break;case h.ERROR:l.numOfUploadFailed++;break;case h.COMPLETE:l.numOfSuccess++;break;case h.CANCELLED:l.numOfCancel++;break;case h.INVALID:l.numOfInvalid++;break}}});f.installTo(g.prototype);return g});a("widgets/queue",["base","uploader","queue","file","lib/file","runtime/client","widgets/widget"],function(e,k,g,l,f,i){var d=e.$,h=/\.\w+$/,j=l.Status;return k.register({"sort-files":"sortFiles","add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset","accept-file":"acceptFile"},{init:function(t){var s=this,o,r,p,q,n,m,u;if(d.isPlainObject(t.accept)){t.accept=[t.accept]}if(t.accept){n=[];for(p=0,r=t.accept.length;p<r;p++){q=t.accept[p].extensions;q&&n.push(q)}if(n.length){m="\\."+n.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$"}s.accept=new RegExp(m,"i")}s.queue=new g();s.stats=s.queue.stats;if(this.request("predict-runtime-type")!=="html5"){return}o=e.Deferred();u=new i("Placeholder");u.connectRuntime({runtimeOrder:"html5"},function(){s._ruid=u.getRuid();o.resolve()});return o.promise()},_wrapFile:function(m){if(!(m instanceof l)){if(!(m instanceof f)){if(!this._ruid){throw new Error("Can't add external files.")}m=new f(this._ruid,m)}m=new l(m)}return m},acceptFile:function(m){var n=!m||m.size<6||this.accept&&h.exec(m.name)&&!this.accept.test(m.name);return !n},_addFile:function(m){var n=this;m=n._wrapFile(m);if(!n.owner.trigger("beforeFileQueued",m)){return}if(!n.acceptFile(m)){n.owner.trigger("error","Q_TYPE_DENIED",m);return}n.queue.append(m);n.owner.trigger("fileQueued",m);return m},getFile:function(m){return this.queue.getFile(m)},addFiles:function(m){var n=this;if(!m.length){m=[m]}m=d.map(m,function(o){return n._addFile(o)});n.owner.trigger("filesQueued",m);if(n.options.auto){n.request("start-upload")}},getStats:function(){return this.stats},removeFile:function(m){var n=this;m=m.id?m:n.queue.getFile(m);m.setStatus(j.CANCELLED);n.owner.trigger("fileDequeued",m)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(m,r){var q=this,n,o,p;if(m){m=m.id?m:q.queue.getFile(m);m.setStatus(j.QUEUED);r||q.request("start-upload");return}n=q.queue.getFiles(j.ERROR);o=0;p=n.length;for(;o<p;o++){m=n[o];m.setStatus(j.QUEUED)}q.request("start-upload")},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.queue=new g();this.stats=this.queue.stats}})});a("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(e,d){e.support=function(){return d.hasRuntime.apply(d,arguments)};return e.register({"predict-runtime-type":"predictRuntmeType"},{init:function(){if(!this.predictRuntmeType()){throw Error("Runtime Error")}},predictRuntmeType:function(){var h=this.options.runtimeOrder||d.orders,j=this.type,f,g;if(!j){h=h.split(/\s*,\s*/g);for(f=0,g=h.length;f<g;f++){if(d.hasRuntime(h[f])){this.type=j=h[f];break}}}return j}})});a("lib/transport",["base","runtime/client","mediator"],function(e,g,f){var d=e.$;function h(j){var i=this;j=i.options=d.extend(true,{},h.options,j||{});g.call(this,"Transport");this._blob=null;this._formData=j.formData||{};this._headers=j.headers||{};this.on("progress",this._timeout);this.on("load error",function(){i.trigger("progress",1);clearTimeout(i._timer)})}h.options={server:"",method:"POST",withCredentials:false,fileVal:"file",timeout:2*60*1000,formData:{},headers:{},sendAsBinary:false};d.extend(h.prototype,{appendBlob:function(k,i,j){var l=this,m=l.options;if(l.getRuid()){l.disconnectRuntime()}l.connectRuntime(i.ruid,function(){l.exec("init")});l._blob=i;m.fileVal=k||m.fileVal;m.filename=j||m.filename},append:function(i,j){if(typeof i==="object"){d.extend(this._formData,i)}else{this._formData[i]=j}},setRequestHeader:function(i,j){if(typeof i==="object"){d.extend(this._headers,i)}else{this._headers[i]=j}},send:function(i){this.exec("send",i);this._timeout()},abort:function(){clearTimeout(this._timer);return this.exec("abort")},destroy:function(){this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var j=this,i=j.options.timeout;if(!i){return}clearTimeout(j._timer);j._timer=setTimeout(function(){j.abort();j.trigger("error","timeout")},i)}});f.installTo(h.prototype);return h});a("widgets/upload",["base","uploader","file","lib/transport","widgets/widget"],function(e,j,k,i){var d=e.$,g=e.isPromise,h=k.Status;d.extend(j.options,{prepareNextFile:false,chunked:false,chunkSize:5*1024*1024,chunkRetry:2,threads:3,formData:null});function f(o,n){var r=[],l=o.source,t=l.size,m=n?Math.ceil(t/n):1,s=0,p=0,q;while(p<m){q=Math.min(n,t-s);r.push({file:o,start:s,end:n?(s+q):t,total:t,chunks:m,chunk:p++});s+=q}o.blocks=r.concat();o.remaning=r.length;return{file:o,has:function(){return !!r.length},fetch:function(){return r.shift()}}}j.register({"start-upload":"start","stop-upload":"stop","skip-file":"skipFile","is-in-progress":"isInProgress"},{init:function(){var l=this.owner;this.runing=false;this.pool=[];this.pending=[];this.remaning=0;this.__tick=e.bindFn(this._tick,this);l.on("uploadComplete",function(m){m.blocks&&d.each(m.blocks,function(n,o){o.transport&&(o.transport.abort(),o.transport.destroy());delete o.transport});delete m.blocks;delete m.remaning})},start:function(){var l=this;d.each(l.request("get-files",h.INVALID),function(){l.request("remove-file",this)});if(l.runing){return}l.runing=true;d.each(l.pool,function(m,o){var n=o.file;if(n.getStatus()===h.INTERRUPT){n.setStatus(h.PROGRESS);l._trigged=false;o.transport&&o.transport.send()}});l._trigged=false;l.owner.trigger("startUpload");e.nextTick(l.__tick)},stop:function(l){var m=this;if(m.runing===false){return}m.runing=false;l&&d.each(m.pool,function(n,o){o.transport&&o.transport.abort();o.file.setStatus(h.INTERRUPT)});m.owner.trigger("stopUpload")},isInProgress:function(){return !!this.runing},getStats:function(){return this.request("get-stats")},skipFile:function(l,m){l=this.request("get-file",l);l.setStatus(m||h.COMPLETE);l.skipped=true;l.blocks&&d.each(l.blocks,function(n,p){var o=p.transport;if(o){o.abort();o.destroy();delete p.transport}});this.owner.trigger("uploadSkip",l)},_tick:function(){var m=this,n=m.options,l,o;if(m._promise){return m._promise.always(m.__tick)}if(m.pool.length<n.threads&&(o=m._nextBlock())){m._trigged=false;l=function(p){m._promise=null;p&&p.file&&m._startSend(p);e.nextTick(m.__tick)};m._promise=g(o)?o.always(l):l(o)}else{if(!m.remaning&&!m.getStats().numOfQueue){m.runing=false;m._trigged||e.nextTick(function(){m.owner.trigger("uploadFinished")});m._trigged=true}}},_nextBlock:function(){var n=this,l=n._act,p=n.options,o,m;if(l&&l.has()&&l.file.getStatus()===h.PROGRESS){if(p.prepareNextFile&&!n.pending.length){n._prepareNextFile()}return l.fetch()}else{if(n.runing){if(!n.pending.length&&n.getStats().numOfQueue){n._prepareNextFile()}o=n.pending.shift();m=function(q){if(!q){return null}l=f(q,p.chunked?p.chunkSize:0);n._act=l;return l.fetch()};return g(o)?o[o.pipe?"pipe":"then"](m):m(o)}}},_prepareNextFile:function(){var m=this,l=m.request("fetch-file"),n=m.pending,o;if(l){o=m.request("before-send-file",l,function(){if(l.getStatus()===h.QUEUED){m.owner.trigger("uploadStart",l);l.setStatus(h.PROGRESS);return l}return m._finishFile(l)});o.done(function(){var p=d.inArray(o,n);~p&&n.splice(p,1,l)});o.fail(function(p){l.setStatus(h.ERROR,p);m.owner.trigger("uploadError",l,p);m.owner.trigger("uploadComplete",l)});n.push(o)}},_popBlock:function(l){var m=d.inArray(l,this.pool);this.pool.splice(m,1);l.file.remaning--;this.remaning--},_startSend:function(l){var n=this,m=l.file,o;n.pool.push(l);n.remaning++;l.blob=l.chunks===1?m.source:m.source.slice(l.start,l.end);o=n.request("before-send",l,function(){if(m.getStatus()===h.PROGRESS){n._doSend(l)}else{n._popBlock(l);e.nextTick(n.__tick)}});o.fail(function(){if(m.remaning===1){n._finishFile(m).always(function(){l.percentage=1;n._popBlock(l);n.owner.trigger("uploadComplete",m);e.nextTick(n.__tick)})}else{l.percentage=1;n._popBlock(l);e.nextTick(n.__tick)}})},_doSend:function(l){var p=this,r=p.owner,q=p.options,n=l.file,u=new i(q),m=d.extend({},q.formData),o=d.extend({},q.headers),s,t;l.transport=u;u.on("destroy",function(){delete l.transport;p._popBlock(l);e.nextTick(p.__tick)});u.on("progress",function(v){var w=0,x=0;w=l.percentage=v;if(l.chunks>1){d.each(n.blocks,function(y,z){x+=(z.percentage||0)*(z.end-z.start)});w=x/n.size}r.trigger("uploadProgress",n,w||0)});s=function(w){var v;t=u.getResponseAsJson()||{};t._raw=u.getResponse();v=function(x){w=x};if(!r.trigger("uploadAccept",l,t,v)){w=w||"server"}return w};u.on("error",function(w,v){l.retried=l.retried||0;if(l.chunks>1&&~"http,abort".indexOf(w)&&l.retried<q.chunkRetry){l.retried++;u.send()}else{if(!v&&w==="server"){w=s(w)}n.setStatus(h.ERROR,w);r.trigger("uploadError",n,w);r.trigger("uploadComplete",n)}});u.on("load",function(){var v;if((v=s())){u.trigger("error",v,true);return}if(n.remaning===1){p._finishFile(n,t)}else{u.destroy()}});m=d.extend(m,{id:n.id,name:n.name,type:n.type,lastModifiedDate:n.lastModifiedDate,size:n.size});l.chunks>1&&d.extend(m,{chunks:l.chunks,chunk:l.chunk});r.trigger("uploadBeforeSend",l,m,o);u.appendBlob(q.fileVal,l.blob,n.name);u.append(m);u.setRequestHeader(o);u.send()},_finishFile:function(l,o,m){var n=this.owner;return n.request("after-send-file",arguments,function(){l.setStatus(h.COMPLETE);n.trigger("uploadSuccess",l,o,m)}).fail(function(p){if(l.getStatus()===h.PROGRESS){l.setStatus(h.ERROR,p)}n.trigger("uploadError",l,p)}).always(function(){n.trigger("uploadComplete",l)})}})});a("widgets/validator",["base","uploader","file","widgets/widget"],function(f,g,i){var d=f.$,h={},e;e={addValidator:function(k,j){h[k]=j},removeValidator:function(j){delete h[j]}};g.register({init:function(){var j=this;d.each(h,function(){this.call(j.owner)})}});e.addValidator("fileNumLimit",function(){var n=this,m=n.options,j=0,l=m.fileNumLimit>>0,k=true;if(!l){return}n.on("beforeFileQueued",function(o){if(j>=l&&k){k=false;this.trigger("error","Q_EXCEED_NUM_LIMIT",l,o);setTimeout(function(){k=true},1)}return j>=l?false:true});n.on("fileQueued",function(){j++});n.on("fileDequeued",function(){j--});n.on("uploadFinished",function(){j=0})});e.addValidator("fileSizeLimit",function(){var n=this,m=n.options,j=0,l=m.fileSizeLimit>>0,k=true;if(!l){return}n.on("beforeFileQueued",function(o){var p=j+o.size>l;if(p&&k){k=false;this.trigger("error","Q_EXCEED_SIZE_LIMIT",l,o);setTimeout(function(){k=true},1)}return p?false:true});n.on("fileQueued",function(o){j+=o.size});n.on("fileDequeued",function(o){j-=o.size});n.on("uploadFinished",function(){j=0})});e.addValidator("fileSingleSizeLimit",function(){var l=this,k=l.options,j=k.fileSingleSizeLimit;if(!j){return}l.on("beforeFileQueued",function(m){if(m.size>j){m.setStatus(i.Status.INVALID,"exceed_size");this.trigger("error","F_EXCEED_SIZE",m);return false}})});e.addValidator("duplicate",function(){var m=this,l=m.options,k={};if(l.duplicate){return}function j(r){var o=0,p=0,q=r.length,n;for(;p<q;p++){n=r.charCodeAt(p);o=n+(o<<6)+(o<<16)-o}return o}m.on("beforeFileQueued",function(n){var o=n.__hash||(n.__hash=j(n.name+n.size+n.lastModifiedDate));if(k[o]){this.trigger("error","F_DUPLICATE",n);return false}});m.on("fileQueued",function(n){var o=n.__hash;o&&(k[o]=true)});m.on("fileDequeued",function(n){var o=n.__hash;o&&(delete k[o])})});return e});a("runtime/compbase",[],function(){function d(e,f){this.owner=e;this.options=e.options;this.getRuntime=function(){return f};this.getRuid=function(){return f.uid};this.trigger=function(){return e.trigger.apply(e,arguments)}}return d});a("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],function(e,j,f){var d=e.$,k="flash",g={};function i(){var n;try{n=navigator.plugins["Shockwave Flash"];n=n.description}catch(l){try{n=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(m){n="0.0"}}n=n.match(/\d+/g);return parseFloat(n[0]+"."+n[1],10)}function h(){var q={},l={},m=this.destory,p=this,o=e.guid("webuploader_");j.apply(p,arguments);p.type=k;p.exec=function(t,u){var s=this,w=s.uid,r=e.slice(arguments,2),v;l[w]=s;if(g[t]){if(!q[w]){q[w]=new g[t](s,p)}v=q[w];if(v[u]){return v[u].apply(v,r)}}return p.flashExec.apply(s,arguments)};function n(r,s){var u=r.type||r,t,v;t=u.split("::");v=t[0];u=t[1];if(u==="Ready"&&v===p.uid){p.trigger("ready")}else{if(l[v]){l[v].trigger(u.toLowerCase(),r,s)}}}c[o]=function(){var r=arguments;setTimeout(function(){n.apply(null,r)},1)};this.jsreciver=o;this.destory=function(){return m&&m.apply(this,arguments)};this.flashExec=function(s,u){var t=p.getFlash(),r=e.slice(arguments,2);return t.exec(this.uid,s,u,r)}}e.inherits(j,{constructor:h,init:function(){var l=this.getContainer(),n=this.options,m;l.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});m='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+n.swf+'" ';if(e.browser.ie){m+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}m+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+n.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';l.html(m)},getFlash:function(){if(this._flash){return this._flash}this._flash=d("#"+this.uid).get(0);return this._flash}});h.register=function(m,l){l=g[m]=e.inherits(f,d.extend({flashExec:function(){var n=this.owner,o=this.getRuntime();return o.flashExec.apply(n,arguments)}},l));return l};if(i()>=11.4){j.addRuntime(k,h)}return h});a("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(e,f){var d=e.$;return f.register("FilePicker",{init:function(k){var g=d.extend({},k),j,h;j=g.accept&&g.accept.length;for(h=0;h<j;h++){if(!g.accept[h].title){g.accept[h].title="Files"}}delete g.button;delete g.container;this.flashExec("FilePicker","init",g)},destroy:function(){}})});a("runtime/flash/image",["runtime/flash/runtime"],function(d){return d.register("Image",{loadFromBlob:function(e){var f=this.owner;f.info()&&this.flashExec("Image","info",f.info());f.meta()&&this.flashExec("Image","meta",f.meta());this.flashExec("Image","loadFromBlob",e.uid)}})});a("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],function(e,f,g){var d=e.$;return f.register("Transport",{init:function(){this._status=0;this._response=null;this._responseJson=null},send:function(){var k=this.owner,j=this.options,m=this._initAjax(),i=k._blob,l=j.server,h;m.connectRuntime(i.ruid);if(j.sendAsBinary){l+=(/\?/.test(l)?"&":"?")+d.param(k._formData);h=i.uid}else{d.each(k._formData,function(n,o){m.exec("append",n,o)});m.exec("appendBlob",j.fileVal,i.uid,j.filename||k._formData.name||"")}this._setRequestHeader(m,j.headers);m.exec("send",{method:j.method,url:l},h)},getStatus:function(){return this._status},getResponse:function(){return this._response},getResponseAsJson:function(){return this._responseJson},abort:function(){var h=this._xhr;if(h){h.exec("abort");h.destroy();this._xhr=h=null}},destroy:function(){this.abort()},_initAjax:function(){var h=this,i=new g("XMLHttpRequest");i.on("uploadprogress progress",function(j){return h.trigger("progress",j.loaded/j.total)});i.on("load",function(){var k=i.exec("getStatus"),j="";i.off();h._xhr=null;if(k>=200&&k<300){h._response=i.exec("getResponse");h._responseJson=i.exec("getResponseAsJson")}else{if(k>=500&&k<600){h._response=i.exec("getResponse");h._responseJson=i.exec("getResponseAsJson");j="server"}else{j="http"}}i.destroy();i=null;return j?h.trigger("error",j):h.trigger("load")});i.on("error",function(){i.off();h._xhr=null;h.trigger("error","http")});h._xhr=i;return i},_setRequestHeader:function(i,h){d.each(h,function(j,k){i.exec("setRequestHeader",j,k)})}})});a("preset/flashonly",["base","widgets/filepicker","widgets/image","widgets/queue","widgets/runtime","widgets/upload","widgets/validator","runtime/flash/filepicker","runtime/flash/image","runtime/flash/transport"],function(d){return d});a("webuploader",["preset/flashonly"],function(d){return d});return b("webuploader")});