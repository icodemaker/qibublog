(function(){var P={},O=[],I=false,M;window.onload=function(){$focus($G("videoUrl"));C();E();D()};function C(){var b=$G("tabHeads").children;for(var a=0;a<b.length;a++){domUtils.on(b[a],"click",function(e){var f,d,c=e.target||e.srcElement;for(f=0;f<b.length;f++){d=b[f].getAttribute("data-content-id");if(b[f]==c){domUtils.addClass(b[f],"focus");domUtils.addClass($G(d),"focus")}else{domUtils.removeClasses(b[f],"focus");domUtils.removeClasses($G(d),"focus")}}})}}function E(){z(["videoFloat","upload_alignment"]);w($G("videoUrl"));v();(function(){var e=editor.selection.getRange().getClosedNode(),a;if(e&&e.className){var c=(e.className=="edui-faked-video"),d=e.className.indexOf("edui-upload-video")!=-1;if(c||d){$G("videoUrl").value=a=e.getAttribute("_url");$G("videoWidth").value=e.width;$G("videoHeight").value=e.height;var b=domUtils.getComputedStyle(e,"float"),f=domUtils.getComputedStyle(e.parentNode,"text-align");L(f==="center"?"center":b)}if(d){I=true}}A(a)})()}function v(){dialog.onok=function(){$G("preview").innerHTML="";var a=B("tabHeads","tabSrc");switch(a){case"video":return G();break;case"videoSearch":return F("searchList");break;case"upload":return H();break}};dialog.oncancel=function(){$G("preview").innerHTML=""}}function L(a){var b=$G("videoFloat").children;for(var d=0,c;c=b[d++];){if(c.getAttribute("name")==a){if(c.className!="focus"){c.className="focus"}}else{if(c.className=="focus"){c.className=""}}}}function G(){var d=$G("videoWidth"),b=$G("videoHeight"),c=$G("videoUrl").value,a=B("videoFloat","name");if(!c){return false}if(!x([d,b])){return false}editor.execCommand("insertvideo",{url:y(c),width:d.value,height:b.value,align:a},I?"upload":null)}function F(b){var d=domUtils.getElementsByTagName($G(b),"img"),e=[];for(var a=0,c;c=d[a++];){if(c.getAttribute("selected")){e.push({url:c.getAttribute("ue_video_url"),width:420,height:280,align:"none"})}}editor.execCommand("insertvideo",e)}function B(d,f){var a=$G(d).children,e;for(var c=0,b;b=a[c++];){if(b.className=="focus"){e=b.getAttribute(f);break}}return e}function y(a){if(!a){return""}a=utils.trim(a).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1");return a}function x(c){for(var b=0,a;a=c[b++];){var d=a.value;if(!J(d)&&d){alert(lang.numError);a.value="";a.focus();return false}}return true}function J(a){return/(0|^[1-9]\d*$)/.test(a)}function z(g){for(var f=0,c;c=g[f++];){var e=$G(c),b={none:lang["default"],left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var a in b){var d=document.createElement("div");d.setAttribute("name",a);if(a=="none"){d.className="focus"}d.style.cssText="background:url(images/"+a+"_focus.jpg);";d.setAttribute("title",b[a]);e.appendChild(d)}K(c)}}function K(c){var d=$G(c).children;for(var b=0,a;a=d[b++];){domUtils.on(a,"click",function(){for(var e=0,f;f=d[e++];){f.className="";f.removeAttribute&&f.removeAttribute("class")}this.className="focus"})}}function w(a){if(browser.ie){a.onpropertychange=function(){A(this.value)}}else{a.addEventListener("input",function(){A(this.value)},false)}}function A(b){if(!b){return}var a=y(b);$G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+'</span></div><embed class="previewVideo" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+a+'" width="'+420+'" height="'+280+'" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" ></embed>'}function H(){var b=[],a=editor.getOpt("videoUrlPrefix"),c=$G("upload_width").value||420,g=$G("upload_height").value||280,d=B("upload_alignment","name")||"none";for(var h in O){var f=O[h];b.push({url:a+f.url,width:c,height:g,align:d})}var e=M.getQueueCount();if(e){$(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,e)+"</span>");return false}else{editor.execCommand("insertvideo",b,"upload")}}function D(){M=new N("queueList")}function N(a){this.$wrap=a.constructor==String?$("#"+a):$(a);this.init()}N.prototype={init:function(){this.fileList=[];this.initContainer();this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var f=this,X=jQuery,e=f.$wrap,b=e.find(".filelist"),c=e.find(".statusBar"),ac=c.find(".info"),d=e.find(".uploadBtn"),ab=e.find(".filePickerBtn"),Z=e.find(".filePickerBlock"),ad=e.find(".placeholder"),a=c.find(".progress").hide(),j=0,l=0,n=window.devicePixelRatio||1,t=113*n,s=113*n,q="",m={},r=(function(){var R=document.createElement("p").style,Q="transition" in R||"WebkitTransition" in R||"MozTransition" in R||"msTransition" in R||"OTransition" in R;R=null;return Q})(),aa,h=editor.getActionUrl(editor.getOpt("videoActionName")),k=editor.getOpt("videoMaxSize"),g=(editor.getOpt("videoAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support()){X("#filePickerReady").after(X("<div>").html(lang.errorNotSupport)).hide();return}else{if(!editor.getOpt("videoActionName")){X("#filePickerReady").after(X("<div>").html(lang.errorLoadConfig)).hide();return}}aa=f.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:h,fileVal:editor.getOpt("videoFieldName"),duplicate:true,fileSingleSizeLimit:k,compress:false});aa.addButton({id:"#filePickerBlock"});aa.addButton({id:"#filePickerBtn",label:lang.uploadAddFile});p("pedding");function i(S){var W=X('<li id="'+S.id+'"><p class="title">'+S.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),U=X('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(W),Q=W.find("p.progress span"),R=W.find("p.imgWrap"),V=X('<p class="error"></p>').hide().appendTo(W),T=function(af){switch(af){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry;break}V.text(text).show()};if(S.getStatus()==="invalid"){T(S.statusText)}else{R.text(lang.uploadPreview);if("|png|jpg|jpeg|bmp|gif|".indexOf("|"+S.ext.toLowerCase()+"|")==-1){R.empty().addClass("notimage").append('<i class="file-preview file-type-'+S.ext.toLowerCase()+'"></i><span class="file-title">'+S.name+"</span>")}else{if(browser.ie&&browser.version<=7){R.text(lang.uploadNoPreview)}else{aa.makeThumb(S,function(ai,aj){if(ai||!aj||(/^data:/.test(aj)&&browser.ie&&browser.version<=7)){R.text(lang.uploadNoPreview)}else{var ah=X('<img src="'+aj+'">');R.empty().append(ah);ah.on("error",function(){R.text(lang.uploadNoPreview)})}},t,s)}}m[S.id]=[S.size,0];S.rotation=0;if(!S.ext||g.indexOf(S.ext.toLowerCase())==-1){T("not_allow_type");aa.removeFile(S)}}S.on("statuschange",function(ag,ah){if(ah==="progress"){Q.hide().width(0)}else{if(ah==="queued"){W.off("mouseenter mouseleave");U.remove()}}if(ag==="error"||ag==="invalid"){T(S.statusText);m[S.id][1]=1}else{if(ag==="interrupt"){T("interrupt")}else{if(ag==="queued"){m[S.id][1]=0}else{if(ag==="progress"){V.hide();Q.css("display","block")}else{if(ag==="complete"){}}}}}W.removeClass("state-"+ah).addClass("state-"+ag)});W.on("mouseenter",function(){U.stop().animate({height:30})});W.on("mouseleave",function(){U.stop().animate({height:0})});U.on("click","span",function(){var ah=X(this).index(),ag;switch(ah){case 0:aa.removeFile(S);return;case 1:S.rotation+=90;break;case 2:S.rotation-=90;break}if(r){ag="rotate("+S.rotation+"deg)";R.css({"-webkit-transform":ag,"-mos-transform":ag,"-o-transform":ag,transform:ag})}else{R.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((S.rotation/90)%4+4)%4)+")")}});W.insertBefore(Z)}function o(R){var Q=X("#"+R.id);delete m[R.id];Y();Q.off().find(".file-panel").off().end().remove()}function Y(){var R=0,Q=0,T=a.children(),S;X.each(m,function(U,V){Q+=V[0];R+=V[0]*V[1]});S=Q?R/Q:0;T.eq(0).text(Math.round(S*100)+"%");T.eq(1).css("width",Math.round(S*100)+"%");u()}function p(S,Q){if(S!=q){var R=aa.getStats();d.removeClass("state-"+q);d.addClass("state-"+S);switch(S){case"pedding":b.addClass("element-invisible");c.addClass("element-invisible");ad.removeClass("element-invisible");a.hide();ac.hide();aa.refresh();break;case"ready":ad.addClass("element-invisible");b.removeClass("element-invisible");c.removeClass("element-invisible");a.hide();ac.show();d.text(lang.uploadStart);aa.refresh();break;case"uploading":a.show();ac.hide();d.text(lang.uploadPause);break;case"paused":a.show();ac.hide();d.text(lang.uploadContinue);break;case"confirm":a.show();ac.hide();d.text(lang.uploadStart);R=aa.getStats();if(R.successNum&&!R.uploadFailNum){p("finish");return}break;case"finish":a.hide();ac.show();if(R.uploadFailNum){d.text(lang.uploadRetry)}else{d.text(lang.uploadStart)}break}q=S;u()}if(!f.getQueueCount()){d.addClass("disabled")}else{d.removeClass("disabled")}}function u(){var R="",Q;if(q==="ready"){R=lang.updateStatusReady.replace("_",j).replace("_KB",WebUploader.formatSize(l))}else{if(q==="confirm"){Q=aa.getStats();if(Q.uploadFailNum){R=lang.updateStatusConfirm.replace("_",Q.successNum).replace("_",Q.successNum)}}else{Q=aa.getStats();R=lang.updateStatusFinish.replace("_",j).replace("_KB",WebUploader.formatSize(l)).replace("_",Q.successNum);if(Q.uploadFailNum){R+=lang.updateStatusError.replace("_",Q.uploadFailNum)}}}ac.html(R)}aa.on("fileQueued",function(Q){j++;l+=Q.size;if(j===1){ad.addClass("element-invisible");c.show()}i(Q)});aa.on("fileDequeued",function(Q){j--;l-=Q.size;o(Q);Y()});aa.on("filesQueued",function(Q){if(!aa.isInProgress()&&(q=="pedding"||q=="finish"||q=="confirm"||q=="ready")){p("ready")}Y()});aa.on("all",function(T,R){switch(T){case"uploadFinished":p("confirm",R);break;case"startUpload":var S=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",Q=utils.formatUrl(h+(h.indexOf("?")==-1?"?":"&")+"encode=utf-8&"+S);aa.option("server",Q);p("uploading",R);break;case"stopUpload":p("paused",R);break}});aa.on("uploadBeforeSend",function(R,Q,S){S.X_Requested_With="XMLHttpRequest"});aa.on("uploadProgress",function(T,Q){var R=X("#"+T.id),S=R.find(".progress span");S.css("width",Q*100+"%");m[T.id][1]=Q;Y()});aa.on("uploadSuccess",function(V,S){var T=X("#"+V.id);try{var R=(S._raw||S),Q=utils.str2json(R);if(Q.state=="SUCCESS"){O.push({url:Q.url,type:Q.type,original:Q.original});T.append('<span class="success"></span>')}else{T.find(".error").text(Q.state).show()}}catch(U){T.find(".error").text(lang.errorServerUpload).show()}});aa.on("uploadError",function(R,Q){});aa.on("error",function(Q,R){if(Q=="Q_TYPE_DENIED"||Q=="F_EXCEED_SIZE"){i(R)}});aa.on("uploadComplete",function(Q,R){});d.on("click",function(){if(X(this).hasClass("disabled")){return false}if(q==="ready"){aa.upload()}else{if(q==="paused"){aa.upload()}else{if(q==="uploading"){aa.stop()}}}});d.addClass("state-"+q);Y()},getQueueCount:function(){var a,c,e,d=0,b=this.uploader.getFiles();for(c=0;a=b[c++];){e=a.getStatus();if(e=="queued"||e=="uploading"||e=="progress"){d++}}return d},refresh:function(){this.uploader.refresh()}}})();