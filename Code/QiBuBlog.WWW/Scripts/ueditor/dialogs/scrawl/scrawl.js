var scrawl=function(b){b&&this.initOptions(b)};(function(){var e=$G("J_brushBoard"),f=e.getContext("2d"),g=[],h=0;scrawl.prototype={isScrawl:false,brushWidth:-1,brushColor:"",initOptions:function(b){var a=this;a.originalState(b);a._buildToolbarColor(b.colorList);a._addBoardListener(b.saveNum);a._addOPerateListener(b.saveNum);a._addColorBarListener();a._addBrushBarListener();a._addEraserBarListener();a._addAddImgListener();a._addRemoveImgListenter();a._addScalePicListenter();a._addClearSelectionListenter();a._originalColorSelect(b.drawBrushColor);a._originalBrushSelect(b.drawBrushSize);a._clearSelection()},originalState:function(b){var a=this;a.brushWidth=b.drawBrushSize;a.brushColor=b.drawBrushColor;f.lineWidth=a.brushWidth;f.strokeStyle=a.brushColor;f.fillStyle="transparent";f.lineCap="round";f.fill()},_buildToolbarColor:function(c){var i=null,a=[];a.push("<table id='J_colorList'>");for(var d=0,b;b=c[d++];){if((d-1)%5==0){if(d!=1){a.push("</tr>")}a.push("<tr>")}i="#"+b;a.push("<td><a title='"+i+"' href='javascript:void(0)' style='background-color:"+i+"'></a></td>")}a.push("</tr></table>");$G("J_colorBar").innerHTML=a.join("")},_addBoardListener:function(t){var s=this,r=0,u=-1,v=-1,d=false,p=false,q=false,b=0,a,c="";r=parseInt(domUtils.getComputedStyle($G("J_wrap"),"margin-left"));g.push(f.getImageData(0,0,f.canvas.width,f.canvas.height));h+=1;domUtils.on(e,["mousedown","mousemove","mouseup","mouseout"],function(i){a=browser.webkit?i.which:b;switch(i.type){case"mousedown":b=1;c=1;d=true;q=false;p=false;s.isScrawl=true;u=i.clientX-r;v=i.clientY-r;f.beginPath();break;case"mousemove":if(!c&&a==0){return}if(!c&&a){u=i.clientX-r;v=i.clientY-r;f.beginPath();c=1}if(q||!d){return}var j=i.clientX-r,k=i.clientY-r;f.moveTo(u,v);f.lineTo(j,k);f.stroke();u=j;v=k;p=true;break;case"mouseup":b=0;if(!d){return}if(!p){f.arc(u,v,f.lineWidth,0,Math.PI*2,false);f.fillStyle=f.strokeStyle;f.fill()}f.closePath();s._saveOPerate(t);d=false;p=false;q=true;u=-1;v=-1;break;case"mouseout":c="";b=0;if(a==1){return}f.closePath();break}})},_addOPerateListener:function(b){var a=this;domUtils.on($G("J_previousStep"),"click",function(){if(h>1){h-=1;f.clearRect(0,0,f.canvas.width,f.canvas.height);f.putImageData(g[h-1],0,0);a.btn2Highlight("J_nextStep");h==1&&a.btn2disable("J_previousStep")}});domUtils.on($G("J_nextStep"),"click",function(){if(h>0&&h<g.length){f.clearRect(0,0,f.canvas.width,f.canvas.height);f.putImageData(g[h],0,0);h+=1;a.btn2Highlight("J_previousStep");h==g.length&&a.btn2disable("J_nextStep")}});domUtils.on($G("J_clearBoard"),"click",function(){f.clearRect(0,0,f.canvas.width,f.canvas.height);g=[];a._saveOPerate(b);h=1;a.isScrawl=false;a.btn2disable("J_previousStep");a.btn2disable("J_nextStep");a.btn2disable("J_clearBoard")})},_addColorBarListener:function(){var a=this;domUtils.on($G("J_colorBar"),"click",function(c){var d=a.getTarget(c),b=d.title;if(!!b){a._addColorSelect(d);a.brushColor=b;f.globalCompositeOperation="source-over";f.lineWidth=a.brushWidth;f.strokeStyle=b}})},_addBrushBarListener:function(){var a=this;domUtils.on($G("J_brushBar"),"click",function(b){var d=a.getTarget(b),c=browser.ie?d.innerText:d.text;if(!!c){a._addBESelect(d);f.globalCompositeOperation="source-over";f.lineWidth=parseInt(c);f.strokeStyle=a.brushColor;a.brushWidth=f.lineWidth}})},_addEraserBarListener:function(){var a=this;domUtils.on($G("J_eraserBar"),"click",function(b){var d=a.getTarget(b),c=browser.ie?d.innerText:d.text;if(!!c){a._addBESelect(d);f.lineWidth=parseInt(c);f.globalCompositeOperation="destination-out";f.strokeStyle="#FFF"}})},_addAddImgListener:function(){var a=$G("J_imgTxt");if(!window.FileReader){$G("J_addImg").style.display="none";$G("J_removeImg").style.display="none";$G("J_sacleBoard").style.display="none"}domUtils.on(a,"change",function(b){var c=a.parentNode;addMaskLayer(lang.backgroundUploading);var j=b.target||b.srcElement,d=new FileReader();d.onload=function(i){var l=i.target||i.srcElement;ue_callback(l.result,"SUCCESS")};d.readAsDataURL(j.files[0]);c.reset()})},_addRemoveImgListenter:function(){var a=this;domUtils.on($G("J_removeImg"),"click",function(){$G("J_picBoard").innerHTML="";a.btn2disable("J_removeImg");a.btn2disable("J_sacleBoard")})},_addScalePicListenter:function(){domUtils.on($G("J_sacleBoard"),"click",function(){var b=$G("J_picBoard"),d=$G("J_scaleCon"),a=b.children[0];if(a){if(!d){b.style.cssText="position:relative;z-index:999;"+b.style.cssText;a.style.cssText="position: absolute;top:"+(e.height-a.height)/2+"px;left:"+(e.width-a.width)/2+"px;";var c=new ScaleBoy();b.appendChild(c.init());c.startScale(a)}else{if(d.style.visibility=="visible"){d.style.visibility="hidden";b.style.position="";b.style.zIndex=""}else{d.style.visibility="visible";b.style.cssText+="position:relative;z-index:999"}}}})},_addClearSelectionListenter:function(){var a=document;domUtils.on(a,"mousemove",function(b){if(browser.ie&&browser.version<11){a.selection.clear()}else{window.getSelection().removeAllRanges()}})},_clearSelection:function(){var c=["J_operateBar","J_colorBar","J_brushBar","J_eraserBar","J_picBoard"];for(var b=0,a;a=c[b++];){domUtils.unSelectable($G(a))}},_saveOPerate:function(b){var a=this;if(g.length<=b){if(h<g.length){a.btn2disable("J_nextStep");g.splice(h)}g.push(f.getImageData(0,0,f.canvas.width,f.canvas.height));h=g.length}else{g.shift();g.push(f.getImageData(0,0,f.canvas.width,f.canvas.height));h=g.length}a.btn2Highlight("J_previousStep");a.btn2Highlight("J_clearBoard")},_originalColorSelect:function(d){var b=$G("J_colorList").getElementsByTagName("td");for(var c=0,a;a=b[c++];){if(a.children[0].title.toLowerCase()==d){a.children[0].style.opacity=1}}},_originalBrushSelect:function(i){var a=$G("J_brushBar").children;for(var c=0,b;b=a[c++];){if(b.tagName.toLowerCase()=="a"){var d=browser.ie?b.innerText:b.text;if(d.toLowerCase()==i){b.style.opacity=1}}}},_addColorSelect:function(x){var u=this,c=$G("J_colorList").getElementsByTagName("td"),i=$G("J_eraserBar").children,a=$G("J_brushBar").children;for(var j=0,b;b=c[j++];){b.children[0].style.opacity=0.3}for(var t=0,d;d=a[t++];){if(d.tagName.toLowerCase()=="a"){d.style.opacity=0.3;var w=browser.ie?d.innerText:d.text;if(w.toLowerCase()==this.brushWidth){d.style.opacity=1}}}for(var k=0,v;v=i[k++];){if(v.tagName.toLowerCase()=="a"){v.style.opacity=0.3}}x.style.opacity=1;x.blur()},_addBESelect:function(n){var a=$G("J_brushBar").children;var c=$G("J_eraserBar").children;for(var d=0,b;b=a[d++];){if(b.tagName.toLowerCase()=="a"){b.style.opacity=0.3}}for(var i=0,j;j=c[i++];){if(j.tagName.toLowerCase()=="a"){j.style.opacity=0.3}}n.style.opacity=1;n.blur()},getCanvasData:function(){var c=$G("J_picBoard"),b=c.children[0];if(b){var d,k;if(b.style.position=="absolute"){d=parseInt(b.style.left);k=parseInt(b.style.top)}else{d=(c.offsetWidth-b.width)/2;k=(c.offsetHeight-b.height)/2}f.globalCompositeOperation="destination-over";f.drawImage(b,d,k,b.width,b.height)}else{f.globalCompositeOperation="destination-atop";f.fillStyle="#fff";f.fillRect(0,0,e.width,e.height)}try{return e.toDataURL("image/png").substring(22)}catch(a){return""}},btn2Highlight:function(b){var a=$G(b);a.className.indexOf("H")==-1&&(a.className+="H")},btn2disable:function(b){var a=$G(b);a.className.indexOf("H")!=-1&&(a.className=a.className.replace("H",""))},getTarget:function(a){return a.target||a.srcElement}}})();var ScaleBoy=function(){this.dom=null;this.scalingElement=null};(function(){function d(){var b=document,j=b.getElementsByTagName("head")[0],k=b.createElement("style"),a=".scale{visibility:hidden;cursor:move;position:absolute;left:0;top:0;width:100px;height:50px;background-color:#fff;font-size:0;line-height:0;opacity:.4;filter:Alpha(opacity=40);}.scale span{position:absolute;left:0;top:0;width:6px;height:6px;background-color:#006DAE;}.scale .hand0, .scale .hand7{cursor:nw-resize;}.scale .hand1, .scale .hand6{left:50%;margin-left:-3px;cursor:n-resize;}.scale .hand2, .scale .hand4, .scale .hand7{left:100%;margin-left:-6px;}.scale .hand3, .scale .hand4{top:50%;margin-top:-3px;cursor:w-resize;}.scale .hand5, .scale .hand6, .scale .hand7{margin-top:-6px;top:100%;}.scale .hand2, .scale .hand5{cursor:ne-resize;}";k.type="text/css";try{k.appendChild(b.createTextNode(a))}catch(c){k.styleSheet.cssText=a}j.appendChild(k)}function e(){var b=document,c,a=[],j=b.createElement("div");j.id="J_scaleCon";j.className="scale";for(var i=0;i<8;i++){a.push("<span class='hand"+i+"'></span>")}j.innerHTML=a.join("");return j}var f=[[1,1,-1,-1],[0,1,0,-1],[0,1,1,-1],[1,0,-1,0],[0,0,1,0],[1,0,-1,1],[0,0,0,1],[0,0,1,1]];ScaleBoy.prototype={init:function(){d();var a=this,b=a.dom=e();a.scaleMousemove.fp=a;domUtils.on(b,"mousedown",function(c){var h=c.target||c.srcElement;a.start={x:c.clientX,y:c.clientY};if(h.className.indexOf("hand")!=-1){a.dir=h.className.replace("hand","")}domUtils.on(document.body,"mousemove",a.scaleMousemove);c.stopPropagation?c.stopPropagation():c.cancelBubble=true});domUtils.on(document.body,"mouseup",function(c){if(a.start){domUtils.un(document.body,"mousemove",a.scaleMousemove);if(a.moved){a.updateScaledElement({position:{x:b.style.left,y:b.style.top},size:{w:b.style.width,h:b.style.height}})}delete a.start;delete a.moved;delete a.dir}});return b},startScale:function(c){var b=this,a=b.dom;a.style.cssText="visibility:visible;top:"+c.style.top+";left:"+c.style.left+";width:"+c.offsetWidth+"px;height:"+c.offsetHeight+"px;";b.scalingElement=c},updateScaledElement:function(b){var a=this.scalingElement,c=b.position,h=b.size;if(c){typeof c.x!="undefined"&&(a.style.left=c.x);typeof c.y!="undefined"&&(a.style.top=c.y)}if(h){h.w&&(a.style.width=h.w);h.h&&(a.style.height=h.h)}},updateStyleByDir:function(a,i){var c=this,b=c.dom,j;f.def=[1,1,0,0];if(f[a][0]!=0){j=parseInt(b.style.left)+i.x;b.style.left=c._validScaledProp("left",j)+"px"}if(f[a][1]!=0){j=parseInt(b.style.top)+i.y;b.style.top=c._validScaledProp("top",j)+"px"}if(f[a][2]!=0){j=b.clientWidth+f[a][2]*i.x;b.style.width=c._validScaledProp("width",j)+"px"}if(f[a][3]!=0){j=b.clientHeight+f[a][3]*i.y;b.style.height=c._validScaledProp("height",j)+"px"}if(a==="def"){c.updateScaledElement({position:{x:b.style.left,y:b.style.top}})}},scaleMousemove:function(b){var c=arguments.callee.fp,k=c.start,a=c.dir||"def",j={x:b.clientX-k.x,y:b.clientY-k.y};c.updateStyleByDir(a,j);arguments.callee.fp.start={x:b.clientX,y:b.clientY};arguments.callee.fp.moved=1},_validScaledProp:function(b,c){var a=this.dom,h=$G("J_picBoard");c=isNaN(c)?0:c;switch(b){case"left":return c<0?0:(c+a.clientWidth)>h.clientWidth?h.clientWidth-a.clientWidth:c;case"top":return c<0?0:(c+a.clientHeight)>h.clientHeight?h.clientHeight-a.clientHeight:c;case"width":return c<=0?1:(c+a.offsetLeft)>h.clientWidth?h.clientWidth-a.offsetLeft:c;case"height":return c<=0?1:(c+a.offsetTop)>h.clientHeight?h.clientHeight-a.offsetTop:c}}}})();function ue_callback(l,k){var g=document,i=$G("J_picBoard"),h=g.createElement("img");function j(b,c,p,e){var r=0,a=0,q,f=b.width||p,d=b.height||e;if(f>c||d>c){if(f>=d){if(r=f-c){q=(r/f).toFixed(2);b.height=d-d*q;b.width=c}}else{if(a=d-c){q=(a/d).toFixed(2);b.width=f-f*q;b.height=c}}}}removeMaskLayer();if(k=="SUCCESS"){i.innerHTML="";h.onload=function(){j(this,300);i.appendChild(h);var a=new scrawl();a.btn2Highlight("J_removeImg");a.btn2Highlight("J_sacleBoard")};h.src=l}else{alert(k)}}function removeMaskLayer(){var b=$G("J_maskLayer");b.className="maskLayerNull";b.innerHTML="";dialog.buttons[0].setDisabled(false)}function addMaskLayer(c){var d=$G("J_maskLayer");dialog.buttons[0].setDisabled(true);d.className="maskLayer";d.innerHTML=c}function exec(scrawlObj){if(scrawlObj.isScrawl){addMaskLayer(lang.scrawlUpLoading);var base64=scrawlObj.getCanvasData();if(!!base64){var options={timeout:100000,onsuccess:function(xhr){if(!scrawlObj.isCancelScrawl){var responseObj;responseObj=eval("("+xhr.responseText+")");if(responseObj.state=="SUCCESS"){var imgObj={},url=editor.options.scrawlUrlPrefix+responseObj.url;imgObj.src=url;imgObj._src=url;imgObj.alt=responseObj.original||"";imgObj.title=responseObj.title||"";editor.execCommand("insertImage",imgObj);dialog.close()}else{alert(responseObj.state)}}},onerror:function(){alert(lang.imageError);dialog.close()}};options[editor.getOpt("scrawlFieldName")]=base64;var actionUrl=editor.getActionUrl(editor.getOpt("scrawlActionName")),params=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",url=utils.formatUrl(actionUrl+(actionUrl.indexOf("?")==-1?"?":"&")+params);ajax.request(url,options)}}else{addMaskLayer(lang.noScarwl+"&nbsp;&nbsp;&nbsp;<input type='button' value='"+lang.continueBtn+"'  onclick='removeMaskLayer()'/>")}};