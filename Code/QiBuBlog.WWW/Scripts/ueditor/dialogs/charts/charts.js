var tableData=[],editorTable=null,chartsConfig=window.typeConfig,resizeTimer=null,currentChartType=0;window.onload=function(){editorTable=domUtils.findParentByTagName(editor.selection.getRange().startContainer,"table",true);if(!editorTable){document.body.innerHTML="<div class='edui-charts-not-data'>未找到数据</div>";return}initChartsTypeView();renderTable(editorTable);initEvent();initUserConfig(editorTable.getAttribute("data-chart"));$("#scrollBed .view-box:eq("+currentChartType+")").trigger("click");updateViewType(currentChartType);dialog.addListener("resize",function(){if(resizeTimer!=null){window.clearTimeout(resizeTimer)}resizeTimer=window.setTimeout(function(){resizeTimer=null;renderCharts()},500)})};function initChartsTypeView(){var d=[];for(var e=0,f=chartsConfig.length;e<f;e++){d.push('<div class="view-box" data-chart-type="'+e+'"><img width="300" src="images/charts'+e+'.png"></div>')}$("#scrollBed").html(d.join(""))}function renderTable(l){var m=[];for(var i=0,k;k=l.rows[i];i++){tableData[i]=[];m[i]=[];for(var j=0,h;h=k.cells[j];j++){var n=getCellValue(h);if(i>0&&j>0){n=+n}if(i===0||j===0){m[i].push("<th>"+n+"</th>")}else{m[i].push('<td><input type="text" class="data-item" value="'+n+'"></td>')}tableData[i][j]=n}m[i]=m[i].join("")}$("#tableContainer").html('<table id="showTable" border="1"><tbody><tr>'+m.join("</tr><tr>")+"</tr></tbody></table>")}function initUserConfig(c){var d={};if(!c){return}c=c.split(";");$.each(c,function(a,b){b=b.split(":");d[b[0]]=b[1]});setUserConfig(d)}function initEvent(){var e=null,f=chartsConfig.length-1,d=$("#scrollBed .view-box");$(".charts-format").delegate(".format-ctrl","change",function(){renderCharts()});$(".table-view").delegate(".data-item","focus",function(){e=this.value}).delegate(".data-item","blur",function(){if(this.value!==e){renderCharts()}e=null});$("#buttonContainer").delegate("a","click",function(a){a.preventDefault();if(this.getAttribute("data-title")==="prev"){if(currentChartType>0){currentChartType--;updateViewType(currentChartType)}}else{if(currentChartType<f){currentChartType++;updateViewType(currentChartType)}}});$("#scrollBed").delegate(".view-box","click",function(a){var b=$(this).attr("data-chart-type");d.removeClass("selected");$(d[b]).addClass("selected");currentChartType=b|0;if(currentChartType===chartsConfig.length-1){disableNotPieConfig()}else{enableNotPieConfig()}renderCharts()})}function renderCharts(){var b=collectData();$("#chartsContainer").highcharts($.extend({},chartsConfig[currentChartType],{credits:{enabled:false},exporting:{enabled:false},title:{text:b.title,x:-20},subtitle:{text:b.subTitle,x:-20},xAxis:{title:{text:b.xTitle},categories:b.categories},yAxis:{title:{text:b.yTitle},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{enabled:true,valueSuffix:b.suffix},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:1},series:b.series}))}function updateViewType(b){$("#scrollBed").css("marginLeft",-b*324+"px")}function collectData(){var d=document.forms["data-form"],c=null;if(currentChartType!==chartsConfig.length-1){c=getSeriesAndCategories();$.extend(c,getUserConfig())}else{c=getSeriesForPieChart();c.title=d.title.value;c.suffix=d.unit.value}return c}function getUserConfig(){var c=document.forms["data-form"],d={title:c.title.value,subTitle:c["sub-title"].value,xTitle:c["x-title"].value,yTitle:c["y-title"].value,suffix:c.unit.value,tableDataFormat:getTableDataFormat(),tip:$("#tipInput").val()};return d}function setUserConfig(c){var d=document.forms["data-form"];c.title&&(d.title.value=c.title);c.subTitle&&(d["sub-title"].value=c.subTitle);c.xTitle&&(d["x-title"].value=c.xTitle);c.yTitle&&(d["y-title"].value=c.yTitle);c.suffix&&(d.unit.value=c.suffix);c.dataFormat=="-1"&&(d["charts-format"][1].checked=true);c.tip&&(d.tip.value=c.tip);currentChartType=c.chartType||0}function getSeriesAndCategories(){var m=document.forms["data-form"],r=[],i=[],t=[],s=getTableData();if(getTableDataFormat()==="-1"){for(var n=0,q=s.length;n<q;n++){for(var o=0,p=s[n].length;o<p;o++){if(!t[o]){t[o]=[]}t[o][n]=s[n][o]}}s=t}i=s[0].slice(1);for(var n=1,j;j=s[n];n++){r.push({name:j[0],data:j.slice(1)})}return{series:r,categories:i}}function getTableDataFormat(){var c=document.forms["data-form"],d=c["charts-format"];return d[0].checked?d[0].value:d[1].value}function disableNotPieConfig(){updateConfigItem("disable")}function enableNotPieConfig(){updateConfigItem("enable")}function updateConfigItem(n){var m=$("#showTable")[0],j=n==="disable"?true:false;for(var i=2,l;l=m.rows[i];i++){for(var k=1,h;h=l.cells[k];k++){$("input",h).attr("disabled",j)}}$("input.not-pie-item").attr("disabled",j);$("#tipInput").attr("disabled",!j)}function getSeriesForPieChart(){var i={type:"pie",name:$("#tipInput").val(),data:[]},j=getTableData();for(var g=1,h=j[0].length;g<h;g++){var k=j[0][g],l=j[1][g];i.data.push([k,l])}return{series:[i]}}function getTableData(){var g=document.getElementById("showTable"),j=g.rows[0].cells.length-1,i=getTableInputValue();for(var f=0,h;h=i[f];f++){tableData[Math.floor(f/j)+1][f%j+1]=i[f]}return tableData}function getTableInputValue(){var i=document.getElementById("showTable"),h=i.getElementsByTagName("input"),j=[];for(var f=0,g;g=h[f];f++){j.push(g.value|0)}return j}function getCellValue(c){var d=utils.trim((c.innerText||c.textContent||""));return d.replace(new RegExp(UE.dom.domUtils.fillChar,"g"),"").replace(/^\s+|\s+$/g,"")}dialog.onok=function(){var c=document.forms["data-form"],d=getUserConfig();d.chartType=currentChartType;syncTableData();editor.execCommand("charts",d)};function syncTableData(){var j=getTableData();for(var g=1,i;i=editorTable.rows[g];g++){for(var h=1,f;f=i.cells[h];h++){f.innerHTML=j[g][h]}}};